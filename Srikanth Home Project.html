<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Family Fitness Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0b1020;
      --card-bg: #151a2c;
      --card-alt-bg: #1c2238;
      --text: #f5f7ff;
      --muted: #a4acc4;
      --accent-blue: #2f80ed;
      --accent-teal: #1abc9c;
      --accent-lime: #a3e635;
      --danger: #ef4444;
      --border-radius: 14px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(148, 163, 184, 0.15);
      color: var(--muted);
    }

    select, input, button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 0.9rem;
      outline: none;
    }

    select, input[type="date"], input[type="number"] {
      background: #020617;
      color: var(--text);
      border: 1px solid #1f2937;
    }

    button {
      cursor: pointer;
      font-weight: 500;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s;
      border-radius: 999px;
    }

    button:active {
      transform: scale(0.97);
      opacity: 0.9;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: #0b1020;
      box-shadow: 0 8px 18px rgba(47, 128, 237, 0.35);
    }

    .btn-outline {
      background: transparent;
      color: var(--muted);
      border: 1px solid #374151;
    }

    .btn-danger {
      background: var(--danger);
      color: #fef2f2;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(145deg, var(--card-bg), var(--card-alt-bg));
      border-radius: var(--border-radius);
      padding: 14px 14px 16px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .metric-tag {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      color: var(--muted);
    }

    .inputs-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .inputs-row input {
      flex: 1 1 90px;
    }

    .small-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .entries-list {
      margin-top: 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      padding-top: 6px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.8rem;
    }

    .entry-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(55, 65, 81, 0.6);
    }

    .entry-row:last-child {
      border-bottom: none;
    }

    .entry-text {
      color: var(--muted);
    }

    .range-buttons {
      display: inline-flex;
      gap: 4px;
      background: rgba(15, 23, 42, 0.9);
      padding: 3px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }

    .range-btn {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .range-btn.active {
      background: #111827;
      color: #e5e7eb;
    }

    .chart-wrapper {
      margin-top: 8px;
      height: 240px;
    }

    .chart-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .theme-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .theme-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent-blue);
    }

    .subtle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .date-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .date-row label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    canvas {
      width: 100% !important;
      min-height: 260px !important;
      display: block;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Family Fitness Dashboard</h1>
      <p>Track daily workouts, habits, and vitals with per‑user dashboards and charts.</p>
      <div class="top-bar">
        <div>
          <span class="small-label">Select user</span><br />
          <select id="userSelect">
            <option value="Srikanth">Srikanth</option>
            <option value="Poornima">Poornima</option>
            <option value="Anirudh">Anirudh</option>
          </select>
        </div>
        <div>
          <span class="small-label">Date</span><br />
          <input type="date" id="dateInput" />
        </div>
        <div class="pill" id="summaryPill">
          Daily entries and charts are stored locally on this device.
        </div>
        <div class="theme-pill">
          <span class="theme-dot" id="themeDot"></span>
          <span id="themeLabel">Theme: Blue</span>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Inputs & Entries -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            Daily Inputs
            <span class="metric-tag">Add multiple entries per day</span>
          </div>
        </div>
        <div class="date-row">
          <label>Selected date entries will be added and shown below.</label>
        </div>
        <div id="metricForms"></div>
      </div>

      <!-- Right: Charts -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            Charts
            <span class="metric-tag">Per metric · 7 / 30 / All</span>
          </div>
          <div class="range-buttons">
            <button class="range-btn active" data-range="7">7d</button>
            <button class="range-btn" data-range="30">30d</button>
            <button class="range-btn" data-range="all">All</button>
          </div>
        </div>
        <div class="subtle">Tap a range to update all charts. Export any chart as PNG.</div>
        <div id="chartsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---

    const STORAGE_KEY = "familyFitnessData_v1";

    const USERS = {
      Srikanth: {
        theme: "blue",
        accent: "#2f80ed",
        metrics: {
          water: { label: "Water (ml)", type: "simple", unit: "ml" },
          cardio: { label: "Cardio (minutes)", type: "simple", unit: "min" },
          vitB12: { label: "Vitamin B12 (taken?)", type: "simple", unit: "1=yes" },
          vitD: { label: "Vitamin D (taken?)", type: "simple", unit: "1=yes" },
          pushups: { label: "Pushups", type: "repsWeight" },
          pullups: { label: "Pull Ups", type: "repsWeight" },
          chest: { label: "Chest Workout", type: "repsWeight" },
          shoulder: { label: "Shoulder Workout", type: "repsWeight" },
          bicepsTriceps: { label: "Biceps / Triceps", type: "repsWeight" },
          legs: { label: "Legs Workout", type: "repsWeight" },
          bloodPressure: { label: "Blood Pressure", type: "bp" }
        }
      },
      Poornima: {
        theme: "teal",
        accent: "#1abc9c",
        metrics: {
          water: { label: "Water (ml)", type: "simple", unit: "ml" },
          cardio: { label: "Cardio (minutes)", type: "simple", unit: "min" },
          vitB12: { label: "Vitamin B12 (taken?)", type: "simple", unit: "1=yes" },
          vitD: { label: "Vitamin D (taken?)", type: "simple", unit: "1=yes" }
        }
      },
      Anirudh: {
        theme: "lime",
        accent: "#a3e635",
        metrics: {
          cardioHiit: { label: "Cardio HIIT (minutes)", type: "simple", unit: "min" },
          cricket: { label: "Cricket Practice (minutes)", type: "simple", unit: "min" },
          water: { label: "Water (ml)", type: "simple", unit: "ml" }
        }
      }
    };

    const THEME_COLORS = {
      blue: "#2f80ed",
      teal: "#1abc9c",
      lime: "#a3e635"
    };

    // --- STATE ---

    let appData = loadData();
    let currentUser = "Srikanth";
    let currentRange = "7"; // "7", "30", "all"
    const charts = {}; // metricKey -> Chart instance

    // --- UTILITIES ---

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch (e) {
        console.warn("Failed to load data", e);
      }
      const base = {};
      Object.keys(USERS).forEach(user => {
        base[user] = {};
      });
      return base;
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    function todayISO() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    function getDateRangeDates(range, userMetricsData) {
      const allDatesSet = new Set();

      Object.values(userMetricsData || {}).forEach(metricObj => {
        Object.keys(metricObj || {}).forEach(date => {
          if (date && date.length === 10) allDatesSet.add(date);
        });
      });

      const allDates = Array.from(allDatesSet).sort();

      if (range === "all" || allDates.length === 0) return allDates;

      const days = range === "7" ? 7 : 30;
      const cutoff = new Date();
      cutoff.setHours(0, 0, 0, 0);
      cutoff.setDate(cutoff.getDate() - (days - 1));

      return allDates.filter(dateStr => {
        const [y, m, d] = dateStr.split("-").map(Number);
        const dt = new Date(y, m - 1, d);
        return dt >= cutoff;
      });
    }

    function ensureUserMetric(user, metricKey) {
      if (!appData[user]) appData[user] = {};
      if (!appData[user][metricKey]) appData[user][metricKey] = {};
    }

    function addEntry(user, metricKey, date, entry) {
      ensureUserMetric(user, metricKey);
      if (!appData[user][metricKey][date]) {
        appData[user][metricKey][date] = [];
      }
      appData[user][metricKey][date].push(entry);
      saveData();
    }

    function deleteEntry(user, metricKey, date, index) {
      if (!appData[user] || !appData[user][metricKey] || !appData[user][metricKey][date]) return;
      appData[user][metricKey][date].splice(index, 1);
      if (appData[user][metricKey][date].length === 0) {
        delete appData[user][metricKey][date];
      }
      saveData();
    }

    function deleteAllForDay(user, metricKey, date) {
      if (!appData[user] || !appData[user][metricKey]) return;
      delete appData[user][metricKey][date];
      saveData();
    }

    function sumArray(arr) {
      return arr.reduce((a, b) => a + b, 0);
    }

    // --- UI BUILDERS ---

    function applyTheme() {
      const userConfig = USERS[currentUser];
      const accent = userConfig.accent;
      document.documentElement.style.setProperty("--accent-blue", accent);
      const themeDot = document.getElementById("themeDot");
      const themeLabel = document.getElementById("themeLabel");
      themeDot.style.background = accent;
      themeLabel.textContent = `Theme: ${
        userConfig.theme.charAt(0).toUpperCase() + userConfig.theme.slice(1)
      }`;
    }

    function buildMetricForms() {
      const container = document.getElementById("metricForms");
      container.innerHTML = "";
      const userConfig = USERS[currentUser];
      const date = document.getElementById("dateInput").value;

      Object.entries(userConfig.metrics).forEach(([key, cfg]) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginTop = "10px";

        const header = document.createElement("div");
        header.className = "card-header";

        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = cfg.label;

        const tag = document.createElement("span");
        tag.className = "metric-tag";
        tag.textContent = "Add entry";

        title.appendChild(tag);
        header.appendChild(title);

        const body = document.createElement("div");

        const inputsRow = document.createElement("div");
        inputsRow.className = "inputs-row";

        let inputElements = {};

        if (cfg.type === "simple") {
          const input = document.createElement("input");
          input.type = "number";
          input.min = "0";
          input.placeholder = cfg.unit || "value";
          input.inputMode = "decimal";
          inputElements.value = input;
          inputsRow.appendChild(input);
        } else if (cfg.type === "repsWeight") {
          const reps = document.createElement("input");
          reps.type = "number";
          reps.min = "0";
          reps.placeholder = "Reps";
          reps.inputMode = "decimal";

          const weight = document.createElement("input");
          weight.type = "number";
          weight.min = "0";
          weight.placeholder = "Weight (kg)";
          weight.inputMode = "decimal";

          inputElements.reps = reps;
          inputElements.weight = weight;
          inputsRow.appendChild(reps);
          inputsRow.appendChild(weight);
        } else if (cfg.type === "bp") {
          const sys = document.createElement("input");
          sys.type = "number";
          sys.min = "0";
          sys.placeholder = "Systolic (High)";

          const dia = document.createElement("input");
          dia.type = "number";
          dia.min = "0";
          dia.placeholder = "Diastolic (Low)";

          const pulse = document.createElement("input");
          pulse.type = "number";
          pulse.min = "0";
          pulse.placeholder = "Pulse";

          inputElements.systolic = sys;
          inputElements.diastolic = dia;
          inputElements.pulse = pulse;

          inputsRow.appendChild(sys);
          inputsRow.appendChild(dia);
          inputsRow.appendChild(pulse);
        }

        body.appendChild(inputsRow);

        const addBtn = document.createElement("button");
        addBtn.className = "btn-primary";
        addBtn.textContent = "Add Entry";
        addBtn.style.marginTop = "4px";
        addBtn.onclick = () => {
          handleAddEntry(key, cfg, inputElements);
        };
        body.appendChild(addBtn);

        const entriesList = document.createElement("div");
        entriesList.className = "entries-list";
        entriesList.id = `entries-${key}`;
        body.appendChild(entriesList);

        const deleteDayBtn = document.createElement("button");
        deleteDayBtn.className = "btn-outline btn-danger";
        deleteDayBtn.textContent = "Delete all entries for this day";
        deleteDayBtn.style.marginTop = "6px";
        deleteDayBtn.style.fontSize = "0.75rem";
        deleteDayBtn.onclick = () => {
          if (confirm(`Delete all ${cfg.label} entries for ${date}?`)) {
            deleteAllForDay(currentUser, key, date);
            refreshEntriesForMetric(key);
            updateCharts();
          }
        };
        body.appendChild(deleteDayBtn);

        card.appendChild(header);
        card.appendChild(body);
        container.appendChild(card);

        refreshEntriesForMetric(key);
      });
    }

    function handleAddEntry(metricKey, cfg, inputs) {
      const date = document.getElementById("dateInput").value;
      if (!date) {
        alert("Please select a date.");
        return;
      }

      let entry = null;

      if (cfg.type === "simple") {
        const val = parseFloat(inputs.value.value);
        if (isNaN(val) || val <= 0) {
          alert("Enter a positive value.");
          return;
        }
        entry = val;
      } else if (cfg.type === "repsWeight") {
        const reps = parseFloat(inputs.reps.value);
        const weight = parseFloat(inputs.weight.value || "0");
        if (isNaN(reps) || reps <= 0) {
          alert("Enter reps.");
          return;
        }
        entry = { reps, weight: isNaN(weight) ? 0 : weight };
      } else if (cfg.type === "bp") {
        const systolic = parseFloat(inputs.systolic.value);
        const diastolic = parseFloat(inputs.diastolic.value);
        const pulse = parseFloat(inputs.pulse.value);
        if (isNaN(systolic) || isNaN(diastolic) || isNaN(pulse)) {
          alert("Enter systolic, diastolic, and pulse.");
          return;
        }
        entry = { systolic, diastolic, pulse };
      }

      addEntry(currentUser, metricKey, date, entry);

      Object.values(inputs).forEach(inp => (inp.value = ""));

      refreshEntriesForMetric(metricKey);
      updateCharts();
    }

    function refreshEntriesForMetric(metricKey) {
      const userConfig = USERS[currentUser];
      const cfg = userConfig.metrics[metricKey];
      const date = document.getElementById("dateInput").value;
      const container = document.getElementById(`entries-${metricKey}`);
      if (!container) return;

      container.innerHTML = "";

      const metricData = (appData[currentUser] || {})[metricKey] || {};
      const entries = metricData[date] || [];

      if (entries.length === 0) {
        const empty = document.createElement("div");
        empty.className = "subtle";
        empty.textContent = "No entries for this date yet.";
        container.appendChild(empty);
        return;
      }

      entries.forEach((entry, index) => {
        const row = document.createElement("div");
        row.className = "entry-row";

        const text = document.createElement("div");
        text.className = "entry-text";

        if (cfg.type === "simple") {
          text.textContent = `${entry} ${cfg.unit || ""}`.trim();
        } else if (cfg.type === "repsWeight") {
          text.textContent = `${entry.reps} reps @ ${entry.weight} kg`;
        } else if (cfg.type === "bp") {
          text.textContent = `Sys: ${entry.systolic}, Dia: ${entry.diastolic}, Pulse: ${entry.pulse}`;
        }

        const delBtn = document.createElement("button");
        delBtn.className = "btn-outline btn-danger";
        delBtn.style.fontSize = "0.7rem";
        delBtn.textContent = "Delete";
        delBtn.onclick = () => {
          if (confirm("Delete this entry?")) {
            deleteEntry(currentUser, metricKey, date, index);
            refreshEntriesForMetric(metricKey);
            updateCharts();
          }
        };

        row.appendChild(text);
        row.appendChild(delBtn);
        container.appendChild(row);
      });
    }

    function buildCharts() {
      const container = document.getElementById("chartsContainer");
      container.innerHTML = "";
      Object.keys(charts).forEach(key => {
        if (charts[key]) charts[key].destroy();
      });

      const userConfig = USERS[currentUser];

      Object.entries(userConfig.metrics).forEach(([key, cfg]) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginTop = "10px";

        const header = document.createElement("div");
        header.className = "card-header";

        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = cfg.label;

        header.appendChild(title);

        const body = document.createElement("div");

        const chartWrapper = document.createElement("div");
        chartWrapper.className = "chart-wrapper";

        const canvas = document.createElement("canvas");
        canvas.id = `chart-${key}`;
        chartWrapper.appendChild(canvas);

        body.appendChild(chartWrapper);

        const actions = document.createElement("div");
        actions.className = "chart-actions";

        const exportBtn = document.createElement("button");
        exportBtn.className = "btn-outline";
        exportBtn.textContent = "Export PNG";
        exportBtn.onclick = () => exportChartPNG(key, cfg.label);

        actions.appendChild(exportBtn);
        body.appendChild(actions);

        card.appendChild(header);
        card.appendChild(body);
        container.appendChild(card);

        const ctx = canvas.getContext("2d");
        charts[key] = createChartInstance(ctx, key, cfg);
      });

      updateCharts();
    }

    function createChartInstance(ctx, metricKey, cfg) {
      const userConfig = USERS[currentUser];
      const accent = userConfig.accent;

      if (cfg.type === "bp") {
        return new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Systolic",
                data: [],
                borderColor: accent,
                backgroundColor: "rgba(59,130,246,0.2)",
                tension: 0.3
              },
              {
                label: "Diastolic",
                data: [],
                borderColor: "#f97316",
                backgroundColor: "rgba(249,115,22,0.2)",
                tension: 0.3
              },
              {
                label: "Pulse",
                data: [],
                borderColor: "#22c55e",
                backgroundColor: "rgba(34,197,94,0.2)",
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(55,65,81,0.4)" }
              },
              y: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(55,65,81,0.4)" }
              }
            },
            plugins: {
              legend: {
                labels: { color: "#e5e7eb" }
              }
            }
          }
        });
      }

      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: cfg.label,
              data: [],
              borderColor: accent,
              backgroundColor: "rgba(59,130,246,0.2)",
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.4)" }
            },
            y: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.4)" }
            }
          },
          plugins: {
            legend: {
              labels: { color: "#e5e7eb" }
            }
          }
        }
      });
    }

    function updateCharts() {
      const userMetricsData = appData[currentUser] || {};
      const dates = getDateRangeDates(currentRange, userMetricsData);

      const userConfig = USERS[currentUser];

      Object.entries(userConfig.metrics).forEach(([key, cfg]) => {
        const chart = charts[key];
        if (!chart) return;

        if (cfg.type === "bp") {
          const systolic = [];
          const diastolic = [];
          const pulse = [];

          dates.forEach(date => {
            const entries = ((userMetricsData[key] || {})[date] || []);
            if (entries.length === 0) {
              systolic.push(null);
              diastolic.push(null);
              pulse.push(null);
            } else {
              const last = entries[entries.length - 1];
              systolic.push(last.systolic);
              diastolic.push(last.diastolic);
              pulse.push(last.pulse);
            }
          });

          chart.data.labels = dates;
          chart.data.datasets[0].data = systolic;
          chart.data.datasets[1].data = diastolic;
          chart.data.datasets[2].data = pulse;
          chart.update();
        } else if (cfg.type === "simple") {
          const values = [];
          dates.forEach(date => {
            const entries = ((userMetricsData[key] || {})[date] || []);
            if (entries.length === 0) {
              values.push(null);
            } else {
              values.push(sumArray(entries));
            }
          });
          chart.data.labels = dates;
          chart.data.datasets[0].data = values;
          chart.update();
        } else if (cfg.type === "repsWeight") {
          const values = [];
          dates.forEach(date => {
            const entries = ((userMetricsData[key] || {})[date] || []);
            if (entries.length === 0) {
              values.push(null);
            } else {
              const totalReps = entries.reduce((sum, e) => sum + (e.reps || 0), 0);
              values.push(totalReps);
            }
          });
          chart.data.labels = dates;
          chart.data.datasets[0].data = values;
          chart.update();
        }
      });
    }

    function exportChartPNG(metricKey, label) {
      const chart = charts[metricKey];
      if (!chart) return;
      const link = document.createElement("a");
      link.href = chart.toBase64Image("image/png", 1.0);
      const safeLabel = label.replace(/\s+/g, "_");
      link.download = `${currentUser}_${safeLabel}.png`;
      link.click();
    }

    // --- EVENT WIRING ---

    function init() {
      const dateInput = document.getElementById("dateInput");
      dateInput.value = todayISO();

      document.getElementById("userSelect").addEventListener("change", e => {
        currentUser = e.target.value;
        applyTheme();
        buildMetricForms();
        buildCharts();
      });

      document.getElementById("dateInput").addEventListener("change", () => {
        buildMetricForms();
      });

      document.querySelectorAll(".range-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".range-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentRange = btn.dataset.range;
          updateCharts();
        });
      });

      applyTheme();
      buildMetricForms();
      buildCharts();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
	